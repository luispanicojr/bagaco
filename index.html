<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Consumo e Estoque de Baga√ßo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Application Structure Plan: Mant√©m a l√≥gica, aplica Glassmorphism e refina UI. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 base */
            background-image: 
                radial-gradient(at 0% 0%, rgba(245, 158, 11, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: #e2e8f0;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(245, 158, 11, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.4);
        }

        .inner-glass {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
        }

        /* Modern Slider Styling */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            transition: background .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f59e0b; /* Amber 500 */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            border: 2px solid #1e293b;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.8);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #f59e0b;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            border: 2px solid #1e293b;
        }

        /* Custom Number Input */
        input[type="number"] {
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }
        input[type="number"]:focus {
            border-color: #f59e0b;
            outline: none;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
        }
        
        /* Text gradients for key numbers */
        .text-gradient {
            background: linear-gradient(to right, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .font-mono-numbers {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Loading animation */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #f59e0b;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Markdown Styles */
        .gemini-response h3 { color: #fbbf24; font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .gemini-response ul { margin-left: 1rem; }
        .gemini-response li { margin-bottom: 0.5rem; position: relative; padding-left: 1rem; }
        .gemini-response li::before { content: "‚Ä¢"; color: #f59e0b; position: absolute; left: 0; font-weight: bold; }
        .gemini-response strong { color: #fff; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8 selection:bg-amber-500 selection:text-white">
    <div class="max-w-7xl mx-auto">
        
        <header class="text-center mb-12 pt-8 relative">
            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-32 bg-amber-500/20 rounded-full blur-3xl -z-10"></div>
            <h1 class="text-4xl sm:text-6xl font-bold tracking-tight text-white mb-2">
                Bio<span class="text-gradient">Energy</span> Analytics
            </h1>
            <p class="text-gray-400 text-lg font-light max-w-2xl mx-auto">
                Plataforma avan√ßada de intelig√™ncia para gest√£o de biomassa e efici√™ncia energ√©tica.
            </p>
        </header>

        <main class="space-y-8">
            <!-- Main Control & KPI Section -->
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Control Panel -->
                <div class="lg:col-span-8 glass-card p-6 lg:p-8">
                    <div class="flex items-center mb-8">
                        <div class="w-1 h-6 bg-amber-500 rounded-full mr-3"></div>
                        <h2 class="text-2xl font-semibold text-white">Par√¢metros Operacionais</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
                        
                        <!-- Inputs Num√©ricos Diretos -->
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="pressaoInput" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Press√£o (bar)</label>
                                    <input id="pressaoInput" type="number" value="92" class="w-full p-3 rounded-lg text-lg font-mono-numbers">
                                </div>
                                <div>
                                    <label for="co2Input" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">CO¬≤ (%)</label>
                                    <input id="co2Input" type="number" value="14.0" step="0.1" class="w-full p-3 rounded-lg text-lg font-mono-numbers">
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="estoqueInicialInput" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Estoque Inicial (t)</label>
                                    <input id="estoqueInicialInput" type="number" value="81000" class="w-full p-3 rounded-lg text-lg font-mono-numbers">
                                </div>
                                <div>
                                    <label for="producaoDiariaInput" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-2">Produ√ß√£o (t/dia)</label>
                                    <input id="producaoDiariaInput" type="number" value="5200" class="w-full p-3 rounded-lg text-lg font-mono-numbers">
                                </div>
                            </div>
                        </div>

                        <!-- Sliders -->
                        <div class="space-y-8">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <label for="vaporSlider" class="text-sm font-medium text-gray-300">Produ√ß√£o de Vapor</label>
                                    <span class="text-sm font-mono-numbers text-amber-400"><span id="vaporValue">250</span> t/h</span>
                                </div>
                                <input id="vaporSlider" type="range" min="50" max="500" value="250" step="10" class="slider">
                            </div>

                            <div>
                                <div class="flex justify-between mb-2">
                                    <label for="eficienciaSlider" class="text-sm font-medium text-gray-300">Efici√™ncia da Caldeira</label>
                                    <span class="text-sm font-mono-numbers text-amber-400"><span id="eficienciaValue">85</span>%</span>
                                </div>
                                <input id="eficienciaSlider" type="range" min="70" max="95" value="85" step="0.5" class="slider">
                            </div>

                            <div>
                                <div class="flex justify-between mb-2">
                                    <label for="umidadeSlider" class="text-sm font-medium text-gray-300">Umidade do Baga√ßo</label>
                                    <span class="text-sm font-mono-numbers text-amber-400"><span id="umidadeValue">55</span>%</span>
                                </div>
                                <input id="umidadeSlider" type="range" min="40" max="65" value="55" step="0.5" class="slider">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label for="fibraSlider" class="text-xs font-medium text-gray-400">Fibra</label>
                                        <span class="text-xs font-mono-numbers text-amber-400"><span id="fibraValue">25</span>%</span>
                                    </div>
                                    <input id="fibraSlider" type="range" min="0" max="50" value="25" step="0.5" class="slider">
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label for="temperaturaSlider" class="text-xs font-medium text-gray-400">Temp. Vapor</label>
                                        <span class="text-xs font-mono-numbers text-amber-400"><span id="temperaturaValue">520</span>¬∞C</span>
                                    </div>
                                    <input id="temperaturaSlider" type="range" min="480" max="550" value="520" class="slider">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Column -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Main Consumption Card -->
                    <div class="glass-card p-6 text-center relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50 group-hover:opacity-100 transition-opacity"></div>
                        <h3 class="text-gray-400 text-xs uppercase tracking-widest mb-1">Consumo Instant√¢neo</h3>
                        <div class="flex items-baseline justify-center space-x-2">
                            <span id="consumoResult" class="text-5xl font-bold text-white font-mono-numbers tracking-tighter">0.00</span>
                            <span class="text-amber-500 font-medium">t/h</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-500">
                             24h: <span id="consumo24hResult" class="text-gray-300 font-mono-numbers">0.00</span> t
                        </div>
                    </div>

                    <!-- Generation Efficiency Card -->
                    <div class="glass-card p-6 relative overflow-hidden">
                         <div class="absolute -right-6 -top-6 w-24 h-24 bg-amber-500/10 rounded-full blur-xl"></div>
                        <h3 class="text-gray-400 text-xs uppercase tracking-widest mb-4">Efici√™ncia de Gera√ß√£o</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-2xl font-bold text-amber-400 font-mono-numbers" id="kwhTonResult">0.0</div>
                                <div class="text-[10px] text-gray-500 uppercase mt-1">kWh / t baga√ßo</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-white font-mono-numbers" id="taxaEvaporacaoResult">0.00</div>
                                <div class="text-[10px] text-gray-500 uppercase mt-1">t vapor / t baga√ßo</div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="inner-glass p-3 text-center">
                            <div class="text-xs text-gray-500 uppercase">PCI (kcal/kg)</div>
                            <div id="pciResult" class="font-mono-numbers text-white font-semibold">0</div>
                        </div>
                        <div class="inner-glass p-3 text-center">
                            <div class="text-xs text-gray-500 uppercase">PCS (kcal/kg)</div>
                            <div id="pcsResult" class="font-mono-numbers text-white font-semibold">0</div>
                        </div>
                        <div class="inner-glass p-3 text-center">
                            <div class="text-xs text-gray-500 uppercase">Entalpia (kJ/kg)</div>
                            <div id="entalpiaResult" class="font-mono-numbers text-white font-semibold">0</div>
                        </div>
                        <div class="inner-glass p-3 text-center">
                            <div class="text-xs text-gray-500 uppercase">Energia (MW)</div>
                            <div id="energiaMwResult" class="font-mono-numbers text-amber-400 font-bold">0.0</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Stock Forecast Section -->
            <section class="glass-card p-6 lg:p-8">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="w-1 h-6 bg-amber-500 rounded-full mr-3"></div>
                        <h2 class="text-2xl font-semibold text-white">Previs√£o de Estoque</h2>
                    </div>
                    <div class="bg-black/30 px-6 py-3 rounded-full border border-white/5 backdrop-blur-sm">
                        <span class="text-gray-400 text-xs uppercase tracking-wider mr-2">Autonomia Estimada</span>
                        <span id="tempoEstoqueResult" class="text-xl font-bold text-amber-400 font-mono-numbers">Calculando...</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-end">
                    <!-- Visualization -->
                    <div class="lg:col-span-2 h-64 relative rounded-xl overflow-hidden inner-glass border-0">
                        <canvas id="bagasseHeap" class="w-full h-full"></canvas>
                        <div class="absolute bottom-4 left-4 bg-black/50 px-3 py-1 rounded text-xs text-gray-400 backdrop-blur-sm pointer-events-none">
                            Volume Visual do P√°tio
                        </div>
                    </div>
                    
                    <!-- Chart -->
                    <div class="lg:col-span-1 h-64 w-full">
                        <canvas id="estoqueChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- AI Analysis Section -->
            <section class="glass-card p-1 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-30"></div>
                <div class="p-6 lg:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <div class="flex items-center mb-4 md:mb-0">
                            <span class="text-2xl mr-3">üß†</span>
                            <h2 class="text-2xl font-semibold text-white">Intelig√™ncia Artificial</h2>
                        </div>
                        <button id="gemini-button" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-amber-600 font-lg rounded-full hover:bg-amber-500 focus:outline-none ring-offset-2 focus:ring-2 ring-amber-400 disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_15px_rgba(245,158,11,0.3)] hover:shadow-[0_0_25px_rgba(245,158,11,0.5)]">
                            <span class="absolute inset-0 w-full h-full rounded-full opacity-0 group-hover:opacity-20 bg-gradient-to-r from-white to-transparent blur"></span>
                            <span class="mr-2">‚ú®</span> Gerar Diagn√≥stico de Otimiza√ß√£o
                        </button>
                    </div>
                    
                    <div id="gemini-response-container" class="inner-glass min-h-[120px] p-6 text-gray-300 leading-relaxed">
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 py-8">
                            <svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            <p>Aguardando solicita√ß√£o de an√°lise...</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Footer Graph -->
             <section class="glass-card p-6 lg:p-8">
                 <div class="flex items-center mb-6">
                    <div class="w-1 h-6 bg-gray-600 rounded-full mr-3"></div>
                    <h2 class="text-xl font-semibold text-gray-300">Curva de Sensibilidade (Umidade vs Consumo)</h2>
                </div>
                <div class="chart-container h-64">
                    <canvas id="umidadeChart"></canvas>
                </div>
            </section>

            <footer class="text-center text-xs text-gray-600 pt-8 pb-8">
                <p class="mb-2">Metodologia: Standard Industry Practices (Biomass Power)</p>
                <p>&copy; 2025 BioEnergy Analytics Suite. v2.4-Glass</p>
            </footer>
        </main>
    </div>

    <script>
        // Chart Global Defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        document.addEventListener('DOMContentLoaded', () => {
            const vaporSlider = document.getElementById('vaporSlider');
            const umidadeSlider = document.getElementById('umidadeSlider');
            const eficienciaSlider = document.getElementById('eficienciaSlider');
            const temperaturaSlider = document.getElementById('temperaturaSlider');
            const fibraSlider = document.getElementById('fibraSlider');
            const pressaoInput = document.getElementById('pressaoInput');
            const co2Input = document.getElementById('co2Input');
            const estoqueInicialInput = document.getElementById('estoqueInicialInput');
            const producaoDiariaInput = document.getElementById('producaoDiariaInput');

            const vaporValue = document.getElementById('vaporValue');
            const umidadeValue = document.getElementById('umidadeValue');
            const eficienciaValue = document.getElementById('eficienciaValue');
            const temperaturaValue = document.getElementById('temperaturaValue');
            const fibraValue = document.getElementById('fibraValue');

            const consumoResult = document.getElementById('consumoResult');
            const consumo24hResult = document.getElementById('consumo24hResult');
            const pciResult = document.getElementById('pciResult');
            const pcsResult = document.getElementById('pcsResult');
            const entalpiaResult = document.getElementById('entalpiaResult');
            const energiaMwResult = document.getElementById('energiaMwResult');
            const kwhTonResult = document.getElementById('kwhTonResult');
            const taxaEvaporacaoResult = document.getElementById('taxaEvaporacaoResult');
            const tempoEstoqueResult = document.getElementById('tempoEstoqueResult');
            
            const bagasseCanvas = document.getElementById('bagasseHeap');
            const bagasseCtx = bagasseCanvas.getContext('2d');

            const geminiButton = document.getElementById('gemini-button');
            const geminiResponseContainer = document.getElementById('gemini-response-container');

            let umidadeChart, estoqueChart;

            const inputs = [vaporSlider, umidadeSlider, eficienciaSlider, temperaturaSlider, fibraSlider, pressaoInput, co2Input, estoqueInicialInput, producaoDiariaInput];

            function getSteamEnthalpy(temp, pressure) {
                const baseEnthalpy = 3445;
                const baseTemp = 520;
                const basePressure = 92;
                const tempCorrection = (temp - baseTemp) * 2.2;
                const pressureCorrection = (pressure - basePressure) * -1.7;
                return baseEnthalpy + tempCorrection + pressureCorrection;
            }
            
            function drawBagasseHeap(percentage) {
                const canvas = bagasseCtx.canvas;
                const w = canvas.width;
                const h = canvas.height;
                bagasseCtx.clearRect(0, 0, w, h);

                if (percentage <= 0) return;

                const maxHeight = h * 0.85 * percentage;
                const baseY = h;

                // Modern gradient fill
                const gradient = bagasseCtx.createLinearGradient(0, h - maxHeight, 0, h);
                gradient.addColorStop(0, '#fbbf24'); // Brighter amber top
                gradient.addColorStop(1, '#78350f'); // Darker bottom

                bagasseCtx.fillStyle = gradient;
                
                bagasseCtx.beginPath();
                bagasseCtx.moveTo(0, baseY);

                const numPoints = 50; // Smoother curve
                for (let i = 0; i <= numPoints; i++) {
                    const x = (i / numPoints) * w;
                    // More complex organic shape math
                    const mainArc = Math.sin((i / numPoints) * Math.PI);
                    const subWaves = Math.sin((i / numPoints) * Math.PI * 5) * 0.08;
                    const microTexture = Math.sin((i / numPoints) * Math.PI * 15) * 0.02;

                    const totalHeightFactor = mainArc * (1 + subWaves + microTexture);
                    const y = baseY - (maxHeight * totalHeightFactor);
                    bagasseCtx.lineTo(x, y);
                }
                
                bagasseCtx.lineTo(w, baseY);
                bagasseCtx.closePath();
                bagasseCtx.fill();

                // Add a glow effect
                bagasseCtx.shadowColor = "rgba(245, 158, 11, 0.5)";
                bagasseCtx.shadowBlur = 20;
            }

            function resizeCanvas() {
                const parent = bagasseCanvas.parentElement;
                bagasseCanvas.width = parent.clientWidth;
                bagasseCanvas.height = parent.clientHeight;
                calculateAndDisplay();
            }
            
            window.addEventListener('resize', resizeCanvas);

            function calculateAndDisplay() {
                const vapor = parseFloat(vaporSlider.value);
                const umidade = parseFloat(umidadeSlider.value);
                const eficiencia = parseFloat(eficienciaSlider.value) / 100;
                const temperatura = parseFloat(temperaturaSlider.value);
                const fibra = parseFloat(fibraSlider.value);
                const pressao = parseFloat(pressaoInput.value) || 92;
                const co2 = parseFloat(co2Input.value) || 0;
                const estoqueInicial = parseFloat(estoqueInicialInput.value) || 0;
                const producaoDiaria = parseFloat(producaoDiariaInput.value) || 0;

                vaporValue.textContent = vapor.toFixed(0);
                umidadeValue.textContent = umidade.toFixed(1);
                eficienciaValue.textContent = (eficiencia * 100).toFixed(1);
                temperaturaValue.textContent = temperatura.toFixed(0);
                fibraValue.textContent = fibra.toFixed(1);
                
                const pciBaseSeco = 4400 + (fibra - 48) * 10;
                const pci = pciBaseSeco - (51 * umidade);
                const pcs = 4650 - (46.5 * umidade);
                
                const entalpiaVaporKJ = getSteamEnthalpy(temperatura, pressao);
                const entalpiaAguaKJ = 419;
                const deltaEntalpiaKJ = entalpiaVaporKJ - entalpiaAguaKJ;
                const KJ_TO_KCAL = 0.239006;
                const deltaEntalpiaKcal = deltaEntalpiaKJ * KJ_TO_KCAL;
                
                const vaporKgH = vapor * 1000;
                const energiaUtilKcalH = vaporKgH * deltaEntalpiaKcal;
                const energiaTotalKcalH = energiaUtilKcalH / eficiencia;
                const consumoKgH = energiaTotalKcalH / pci;
                
                const consumoTonH = consumoKgH / 1000;
                const consumo24h = consumoTonH * 24;
                
                const consumoEspecificoTurbina = 5.2;
                const energiaMw = vapor / consumoEspecificoTurbina;
                
                const kwhPerTon = consumoTonH > 0 ? (energiaMw * 1000) / consumoTonH : 0;
                const steamBagasseRatio = consumoTonH > 0 ? vapor / consumoTonH : 0;

                consumoResult.textContent = isNaN(consumoTonH) ? '0.00' : consumoTonH.toFixed(2);
                consumo24hResult.textContent = isNaN(consumo24h) ? '0.00' : consumo24h.toFixed(2);
                pciResult.textContent = isNaN(pci) ? '0' : pci.toFixed(0);
                pcsResult.textContent = isNaN(pcs) ? '0' : pcs.toFixed(0);
                entalpiaResult.textContent = isNaN(entalpiaVaporKJ) ? '0' : entalpiaVaporKJ.toFixed(0);
                energiaMwResult.textContent = isNaN(energiaMw) ? '0.0' : energiaMw.toFixed(1);
                kwhTonResult.textContent = isNaN(kwhPerTon) ? '0.0' : kwhPerTon.toFixed(1);
                taxaEvaporacaoResult.textContent = isNaN(steamBagasseRatio) ? '0.00' : steamBagasseRatio.toFixed(2);

                const saldoDiario = producaoDiaria - consumo24h;
                if (saldoDiario >= 0) {
                    tempoEstoqueResult.textContent = 'Sustent√°vel';
                    tempoEstoqueResult.classList.remove('text-red-400');
                    tempoEstoqueResult.classList.add('text-emerald-400');
                } else if (estoqueInicial <= 0) {
                    tempoEstoqueResult.textContent = 'Esgotado';
                    tempoEstoqueResult.classList.add('text-red-400');
                    tempoEstoqueResult.classList.remove('text-emerald-400');
                } else {
                    const diasParaAcabar = estoqueInicial / Math.abs(saldoDiario);
                    const dias = Math.floor(diasParaAcabar);
                    const horas = Math.round((diasParaAcabar - dias) * 24);
                    tempoEstoqueResult.textContent = `${dias}d e ${horas}h`;
                    tempoEstoqueResult.classList.remove('text-emerald-400');
                    tempoEstoqueResult.classList.add('text-amber-400');
                }
                
                const maxEstoqueVisual = Math.max(100000, estoqueInicial * 1.2); 
                const estoquePercent = Math.min(estoqueInicial / maxEstoqueVisual, 1);
                drawBagasseHeap(estoquePercent);
                
                updateUmidadeChartData();
                updateEstoqueChartData();
            }

            function updateUmidadeChartData() {
                const vapor = parseFloat(vaporSlider.value);
                const eficiencia = parseFloat(eficienciaSlider.value) / 100;
                const temperatura = parseFloat(temperaturaSlider.value);
                const fibra = parseFloat(fibraSlider.value);
                const pressao = parseFloat(pressaoInput.value) || 92;
                
                const entalpiaVaporKJ = getSteamEnthalpy(temperatura, pressao);
                const deltaEntalpiaKcal = (entalpiaVaporKJ - 419) * 0.239006;
                const energiaTotalKcalH = (vapor * 1000 * deltaEntalpiaKcal) / eficiencia;
                const pciBaseSeco = 4400 + (fibra - 48) * 10;

                const labels = [];
                const data = [];
                for (let u = 40; u <= 65; u += 1) {
                    labels.push(u);
                    const pci = pciBaseSeco - (51 * u);
                    const consumo = (energiaTotalKcalH / pci) / 1000;
                    data.push(consumo);
                }

                if(umidadeChart) {
                    umidadeChart.data.labels = labels;
                    umidadeChart.data.datasets[0].data = data;
                    umidadeChart.update();
                }
            }

            function updateEstoqueChartData() {
                const estoqueInicial = parseFloat(estoqueInicialInput.value) || 0;
                const producaoDiaria = parseFloat(producaoDiariaInput.value) || 0;
                const consumo24h = parseFloat(consumo24hResult.textContent) || 0;
                const saldoDiario = producaoDiaria - consumo24h;

                const labels = [];
                const data = [];
                for (let i = 0; i <= 30; i++) {
                    labels.push(i === 0 ? 'Hoje' : `${i}d`);
                    const estoqueAtual = estoqueInicial + (saldoDiario * i);
                    data.push(Math.max(0, estoqueAtual));
                }
                if(estoqueChart) {
                    estoqueChart.data.labels = labels;
                    estoqueChart.data.datasets[0].data = data;
                    estoqueChart.update();
                }
            }

            function createUmidadeChart() {
                const ctx = document.getElementById('umidadeChart').getContext('2d');
                umidadeChart = new Chart(ctx, {
                    type: 'line',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Consumo (t/h)', 
                            data: [], 
                            borderColor: '#f59e0b', 
                            backgroundColor: 'rgba(245, 158, 11, 0.1)', 
                            borderWidth: 3, 
                            pointBackgroundColor: '#f59e0b',
                            fill: true, 
                            tension: 0.4 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: { 
                            y: { grid: { color: 'rgba(255,255,255,0.05)' } }, 
                            x: { grid: { display: false } } 
                        }
                    }
                });
            }
            
            function createEstoqueChart() {
                const ctx = document.getElementById('estoqueChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
                gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

                estoqueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{ 
                            label: 'Estoque (t)', 
                            data: [], 
                            borderColor: '#f59e0b', 
                            backgroundColor: gradient, 
                            borderWidth: 3, 
                            fill: true, 
                            tension: 0.2,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            function markdownToHtml(md) {
                return md
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')
                    .replace(/<\/ul><ul>/gim, '')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
            }

            async function callGeminiApi() {
                geminiButton.disabled = true;
                const originalBtnContent = geminiButton.innerHTML;
                geminiButton.innerHTML = '<div class="spinner mr-2"></div> Analisando...';
                geminiResponseContainer.innerHTML = '<div class="flex flex-col justify-center items-center h-full animate-pulse"><div class="spinner mb-4"></div><p class="text-amber-400">Consultando Intelig√™ncia Artificial...</p></div>';
                
                const data = {
                    vapor: vaporValue.textContent,
                    umidade: umidadeValue.textContent,
                    eficiencia: eficienciaValue.textContent,
                    fibra: fibraValue.textContent,
                    pressao: pressaoInput.value,
                    co2: co2Input.value,
                    pci: pciResult.textContent,
                    pcs: pcsResult.textContent,
                    entalpia: entalpiaResult.textContent,
                    energiaMw: energiaMwResult.textContent,
                    kwhTon: kwhTonResult.textContent,
                    taxaEvaporacao: taxaEvaporacaoResult.textContent,
                    estoque: estoqueInicialInput.value,
                    producaoDiaria: producaoDiariaInput.value,
                    consumoDiario: consumo24hResult.textContent,
                    previsao: tempoEstoqueResult.textContent
                };

                const systemPrompt = "Voc√™ √© um especialista s√™nior em engenharia de utilidades industriais e cogera√ß√£o de energia a biomassa. Seu objetivo √© fornecer an√°lises t√©cnicas de alto n√≠vel.";
                
                const userQuery = `
                    Realize uma an√°lise t√©cnica aprofundada dos seguintes par√¢metros operacionais de uma caldeira a baga√ßo de cana:

                    ### Par√¢metros de Entrada
                    - Produ√ß√£o de Vapor: ${data.vapor} t/h @ ${data.pressao} bar / ${temperaturaValue.textContent}¬∞C
                    - Qualidade do Combust√≠vel: Umidade ${data.umidade}% | Fibra ${data.fibra}%
                    - Efici√™ncia da Caldeira: ${data.eficiencia}%
                    - Gases de Combust√£o: CO‚ÇÇ ${data.co2}%

                    ### Indicadores de Performance Calculados
                    - PCI: ${data.pci} kcal/kg
                    - Consumo Espec√≠fico: ${data.kwhTon} kWh/t baga√ßo
                    - Taxa de Evapora√ß√£o: ${data.taxaEvaporacao} t vapor/t baga√ßo
                    - Gera√ß√£o El√©trica: ${data.energiaMw} MW
                    - Status de Estoque: ${data.estoque}t (Previs√£o: ${data.previsao})

                    ### Solicita√ß√£o
                    1. **Diagn√≥stico Operacional:** Avalie a efici√™ncia t√©rmica e el√©trica atual. Comente sobre a qualidade da combust√£o baseada no CO¬≤.
                    2. **Plano de A√ß√£o:** Liste 3 estrat√©gias t√©cnicas concretas para maximizar a gera√ß√£o ou reduzir o consumo espec√≠fico.
                    3. **An√°lise de Risco:** Aponte riscos potenciais com o n√≠vel de estoque atual e a qualidade do baga√ßo informada.

                    Formate a resposta de forma executiva, usando Markdown, bullet points e negrito para m√©tricas chave.
                `;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Erro: ${response.status}`);

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        geminiResponseContainer.innerHTML = markdownToHtml(text);
                        geminiResponseContainer.classList.add("gemini-response");
                    } else {
                        throw new Error("Resposta vazia.");
                    }
                } catch (error) {
                    geminiResponseContainer.innerHTML = '<p class="text-red-400 text-center">Falha na conex√£o com a IA. Verifique sua rede e tente novamente.</p>';
                } finally {
                    geminiButton.disabled = false;
                    geminiButton.innerHTML = originalBtnContent;
                }
            }
            
            geminiButton.addEventListener('click', callGeminiApi);

            createUmidadeChart();
            createEstoqueChart();
            resizeCanvas();

            inputs.forEach(input => {
                input.addEventListener('input', calculateAndDisplay);
            });
        });
    </script>
</body>
</html>
